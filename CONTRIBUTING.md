# Contributing to Zerobus TypeScript SDK

Thank you for your interest in contributing to the Zerobus TypeScript SDK! This document provides guidelines and instructions for contributing.

## Development Setup

### Prerequisites

- Node.js >= 16
- Rust toolchain (1.70+)
- Cargo
- Git

### Getting Started

1. Fork and clone the repository:
```bash
git clone https://github.com/YOUR_USERNAME/zerobus-sdk-ts.git
cd zerobus-sdk-ts
```

2. Install dependencies:
```bash
npm install
```

3. Build the project:
```bash
npm run build:debug
```

4. Run tests:
```bash
npm test
```

## Project Structure

```
zerobus-sdk-ts/
├── src/
│   └── lib.rs              # NAPI-RS bindings (Rust)
├── examples/               # TypeScript examples
├── .github/
│   └── workflows/          # CI/CD workflows
├── Cargo.toml              # Rust dependencies
├── package.json            # npm package configuration
├── build.rs                # Rust build script
└── README.md
```

## Making Changes

### Adding New Features

1. Check if the feature exists in the [Rust SDK](https://github.com/databricks/zerobus-sdk-rs)
2. If not in Rust SDK, consider contributing there first
3. Add NAPI-RS bindings in `src/lib.rs`
4. Update TypeScript type definitions (auto-generated by NAPI-RS)
5. Add examples demonstrating the feature
6. Update documentation

### Modifying Bindings

The bindings are defined in `src/lib.rs` using NAPI-RS macros:

```rust
#[napi]
pub struct MyType {
    // Fields
}

#[napi]
impl MyType {
    #[napi]
    pub async fn my_method(&self, param: String) -> Result<i32> {
        // Implementation
    }
}
```

NAPI-RS automatically generates:
- TypeScript type definitions (`.d.ts`)
- JavaScript binding code (`.js`)
- Native addon compilation

### Testing

Add tests in the `test/` directory (to be created):

```typescript
import { ZerobusSdk } from '../index';
import { describe, it } from 'node:test';
import assert from 'node:assert';

describe('ZerobusSdk', () => {
    it('should create SDK instance', () => {
        const sdk = new ZerobusSdk(
            'https://test.zerobus.example.com',
            'https://test.example.com'
        );
        assert.ok(sdk);
    });
});
```

Run tests:
```bash
npm test
```

### Documentation

- Update README.md for user-facing changes
- Add JSDoc comments to public APIs
- Include code examples for new features
- Update CHANGELOG.md

## Building

### Debug Build
Faster compilation, includes debug symbols:
```bash
npm run build:debug
```

### Release Build
Optimized for production:
```bash
npm run build
```

### Cross-Platform Builds
Build for specific targets:
```bash
npm run build --target x86_64-apple-darwin
npm run build --target x86_64-unknown-linux-gnu
npm run build --target x86_64-pc-windows-msvc
```

## Pull Request Process

1. **Create a feature branch**
   ```bash
   git checkout -b feature/my-new-feature
   ```

2. **Make your changes**
   - Write clear, self-documenting code
   - Add tests for new functionality
   - Update documentation

3. **Test thoroughly**
   ```bash
   npm run build:debug
   npm test
   ```

4. **Commit your changes**
   - Use clear, descriptive commit messages
   - Follow conventional commits format:
     ```
     feat: add support for custom headers
     fix: resolve memory leak in stream closure
     docs: update API reference
     ```

5. **Push to your fork**
   ```bash
   git push origin feature/my-new-feature
   ```

6. **Open a Pull Request**
   - Describe what changed and why
   - Link any related issues
   - Include test results
   - Add screenshots/examples if applicable

## Code Style

### Rust Code
Follow standard Rust formatting:
```bash
cargo fmt --all
cargo clippy --all-targets --all-features
```

### TypeScript/JavaScript
Follow standard TypeScript conventions:
- Use camelCase for variables and functions
- Use PascalCase for types and classes
- Prefer `const` over `let`
- Use async/await over Promise chains

## Debugging

### Enable Rust Logging
```bash
export RUST_LOG=debug
npm run build:debug
```

### Debug Native Addon
```bash
# macOS/Linux
lldb node
> run your_script.js

# Windows
windbg node.exe your_script.js
```

### Common Issues

**Build fails with "cannot find -lprost"**
- Run `cargo clean`
- Delete `target/` directory
- Rebuild: `npm run build:debug`

**"Module not found" at runtime**
- Ensure you ran `npm run build`
- Check that `*.node` file exists
- Verify Node.js version >= 16

## Performance Considerations

When adding features:
- Minimize data copying between JS and Rust
- Use zero-copy buffers where possible
- Avoid blocking the event loop
- Use async operations for I/O

NAPI-RS best practices:
- Use `Buffer` for binary data (zero-copy)
- Use `&[u8]` for read-only slices
- Avoid `Vec<String>` for large arrays
- Prefer streaming over buffering

## Release Process

1. Update version in `package.json` and `Cargo.toml`
2. Update CHANGELOG.md
3. Create a git tag: `git tag v0.1.0`
4. Push tag: `git push origin v0.1.0`
5. GitHub Actions will automatically build and publish

## Getting Help

- Open an [issue](https://github.com/databricks/zerobus-sdk-ts/issues) for bugs
- Start a [discussion](https://github.com/databricks/zerobus-sdk-ts/discussions) for questions
- Check the [Rust SDK docs](https://github.com/databricks/zerobus-sdk-rs) for underlying functionality
- Review [NAPI-RS documentation](https://napi.rs) for binding questions

## License

By contributing, you agree that your contributions will be licensed under the Databricks License.
