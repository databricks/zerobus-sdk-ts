# Contributing to Zerobus SDK for TypeScript

We happily welcome contributions to the Zerobus SDK for TypeScript. We use [GitHub Issues](https://github.com/databricks/zerobus-sdk-ts/issues) to track community reported issues and [GitHub Pull Requests](https://github.com/databricks/zerobus-sdk-ts/pulls) for accepting changes.

Contributions are licensed on a license-in/license-out basis.

## Communication

Before starting work on a major feature, please open a GitHub issue. We will make sure no one else is already working on it and that it is aligned with the goals of the project.

A "major feature" is defined as any change that is > 100 LOC altered (not including tests), or changes any user-facing behavior.

We will use the GitHub issue to discuss the feature and come to agreement. This is to prevent your time being wasted, as well as ours. The GitHub review process for major features is also important so that organizations with commit access can come to agreement on design.

If it is appropriate to write a design document, the document must be hosted either in the GitHub tracking issue, or linked to from the issue and hosted in a world-readable location.

Small patches and bug fixes don't need prior communication.

## Development Setup

### Prerequisites

- Node.js >= 16
- Rust toolchain (1.70+)
- Cargo
- Git

### Getting Started

1. **Clone the repository:**
   ```bash
   git clone https://github.com/databricks/zerobus-sdk-ts.git
   cd zerobus-sdk-ts
   ```

2. **Install dependencies:**
   ```bash
   npm install
   ```

3. **Build the project:**
   ```bash
   npm run build:debug
   ```

4. **Run tests:**
   ```bash
   npm test
   ```

## Project Structure

```
zerobus-sdk-ts/
├── src/
│   ├── lib.rs              # NAPI-RS bindings (Rust)
│   └── headers_provider.ts # TypeScript interfaces
├── utils/
│   └── descriptor.ts       # Protocol Buffer utilities
├── examples/               # TypeScript examples
├── test/                   # Test files
├── .github/
│   └── workflows/          # CI/CD workflows
├── Cargo.toml              # Rust dependencies
├── package.json            # npm package configuration
├── build.rs                # Rust build script
└── README.md
```

## Making Changes

### Adding New Features

1. Check if the feature exists in the [Rust SDK](https://github.com/databricks/zerobus-sdk-rs)
2. If not in Rust SDK, consider contributing there first
3. Add NAPI-RS bindings in `src/lib.rs`
4. Update TypeScript type definitions (auto-generated by NAPI-RS)
5. Add examples demonstrating the feature
6. Update documentation

### Modifying Bindings

The bindings are defined in `src/lib.rs` using NAPI-RS macros:

```rust
#[napi]
pub struct MyType {
    // Fields
}

#[napi]
impl MyType {
    #[napi]
    pub async fn my_method(&self, param: String) -> Result<i32> {
        // Implementation
    }
}
```

NAPI-RS automatically generates:
- TypeScript type definitions (`.d.ts`)
- JavaScript binding code (`.js`)
- Native addon compilation

### Testing

Add tests in the `test/` directory:

```typescript
import { ZerobusSdk } from '../index';
import { describe, it } from 'node:test';
import assert from 'node:assert';

describe('ZerobusSdk', () => {
    it('should create SDK instance', () => {
        const sdk = new ZerobusSdk(
            'https://test.zerobus.example.com',
            'https://test.example.com'
        );
        assert.ok(sdk);
    });
});
```

Run tests:
```bash
npm test
npm run test:unit      # Unit tests only
npm run test:integration  # Integration tests
```

### Documentation

- Update README.md for user-facing changes
- Add JSDoc comments to public APIs
- Include code examples for new features
- Update CHANGELOG.md and NEXT_CHANGELOG.md

## Building

### Debug Build
Faster compilation, includes debug symbols:
```bash
npm run build:debug
```

### Release Build
Optimized for production:
```bash
npm run build
```

### Cross-Platform Builds
Build for specific targets:
```bash
npm run build --target x86_64-apple-darwin
npm run build --target x86_64-unknown-linux-gnu
npm run build --target x86_64-pc-windows-msvc
```

## Code Style

### Rust Code
Follow standard Rust formatting:
```bash
cargo fmt --all
cargo clippy --all-targets --all-features
```

### TypeScript/JavaScript
Follow standard TypeScript conventions:
- Use camelCase for variables and functions
- Use PascalCase for types and classes
- Prefer `const` over `let`
- Use async/await over Promise chains

## Pull Request Process

1. **Create a feature branch:**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make your changes:**
   - Write clear, self-documenting code
   - Add tests for new functionality
   - Update documentation

3. **Format and test your code:**
   ```bash
   cargo fmt --all
   npm test
   ```

4. **Commit your changes:**
   ```bash
   git add .
   git commit -s -m "Add feature: description of your changes"
   ```
   Note: Use `-s` flag to sign your commits (see [Signed Commits](#signed-commits) section).

5. **Push to your fork:**
   ```bash
   git push origin feature/your-feature-name
   ```

6. **Create a Pull Request:**
   - Provide a clear description of changes
   - Reference any related issues
   - Ensure all CI checks pass

## Signed Commits

This repo requires all contributors to sign their commits. To configure this, you can follow [Github's documentation](https://docs.github.com/en/authentication/managing-commit-signature-verification/signing-commits) to create a GPG key, upload it to your Github account, and configure your git client to sign commits.

## Developer Certificate of Origin

To contribute to this repository, you must sign off your commits to certify that you have the right to contribute the code and that it complies with the open source license. The rules are pretty simple, if you can certify the content of [DCO](./DCO), then simply add a "Signed-off-by" line to your commit message to certify your compliance. Please use your real name as pseudonymous/anonymous contributions are not accepted.

```
Signed-off-by: Joe Smith <joe.smith@email.com>
```

If you set your `user.name` and `user.email` git configs, you can sign your commit automatically with `git commit -s`:

```bash
git commit -s -m "Your commit message"
```

## Code Review Guidelines

When reviewing code:

- Check for adherence to code style
- Look for potential edge cases
- Consider performance implications
- Ensure documentation is updated

## Commit Message Guidelines

Follow these conventions for commit messages:

- Use present tense: "Add feature" not "Added feature"
- Use imperative mood: "Fix bug" not "Fixes bug"
- First line should be 50 characters or less
- Reference issues: "Fix #123: Description of fix"

Example:
```
Add batch ingestion support

- Implement ingestRecords() method for batch operations
- Add getUnackedBatches() for batch recovery
- Update README with batch ingestion examples

Fixes #42
```

## Debugging

### Enable Rust Logging
```bash
export RUST_LOG=debug
npm run build:debug
```

### Debug Native Addon
```bash
# macOS/Linux
lldb node
> run your_script.js

# Windows
windbg node.exe your_script.js
```

### Common Issues

**Build fails with "cannot find -lprost"**
- Run `cargo clean`
- Delete `target/` directory
- Rebuild: `npm run build:debug`

**"Module not found" at runtime**
- Ensure you ran `npm run build`
- Check that `*.node` file exists
- Verify Node.js version >= 16

## Performance Considerations

When adding features:
- Minimize data copying between JS and Rust
- Use zero-copy buffers where possible
- Avoid blocking the event loop
- Use async operations for I/O

NAPI-RS best practices:
- Use `Buffer` for binary data (zero-copy)
- Use `&[u8]` for read-only slices
- Avoid `Vec<String>` for large arrays
- Prefer streaming over buffering

## Continuous Integration

All pull requests must pass CI checks:

- **Rust formatting**: `cargo fmt --check`
- **Rust linting**: `cargo clippy`
- **Tests**: Unit and integration tests
- **Build**: Cross-platform builds for all supported targets

You can view CI results in the GitHub Actions tab of the pull request.

## Versioning

We follow [Semantic Versioning](https://semver.org/):

- **MAJOR**: Incompatible API changes
- **MINOR**: Backwards-compatible functionality additions
- **PATCH**: Backwards-compatible bug fixes

## Package Name

The package is published on npm as `@databricks/zerobus-ingest-sdk` in the `eng-lakeflow-connect` team within the `@databricks` organization.

## Code of Conduct

- Be respectful and inclusive
- Welcome newcomers
- Focus on constructive feedback
- Follow the GitHub Community Guidelines

## Getting Help

- **Issues**: Open an issue on GitHub for bugs or feature requests
- **Discussions**: Use GitHub Discussions for questions
- **Documentation**: Check the README and examples/
- **Rust SDK**: Review [Rust SDK documentation](https://github.com/databricks/zerobus-sdk-rs) for underlying functionality
- **NAPI-RS**: Review [NAPI-RS documentation](https://napi.rs) for binding questions

## License

By contributing, you agree that your contributions will be licensed under the Databricks License.
